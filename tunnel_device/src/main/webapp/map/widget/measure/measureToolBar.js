require(["dojo/dom","dojo/query","dojo/_base/lang","dojo/on","esri/graphic","esri/layers/GraphicsLayer","esri/toolbars/draw","esri/Color","esri/symbols/Font","esri/geometry/Polyline","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/TextSymbol","esri/geometry/geometryEngine","dojo/topic"],function(e,t,a,s,c,r,i,o,n,l,h,u,_,m,p){MeasureToolBar=DObject({map:null,defaults:{lineSymbol:new u(u.STYLE_SOLID,new o("#5aff0a"),2),markerSymbol:new h(h.STYLE_CIRCLE,8,new u(u.STYLE_SOLID,new o("#DC143C"),2),new o("#5aff0a"))},measure_toolBar:null,_stopPoints:null,_stopDistances:null,_measureLayer:null,_mapClickFlag:null,construct:function(e){this.map=e,this.map.getLayer("p_measure_layer")?this.map.getLayer("p_measure_layer").clear():(this._measureLayer=new r({id:"p_measure_layer"}),this.map.addLayer(this._measureLayer)),p.subscribe("clearMeasureLayer",a.hitch(this,function(){this._measureLayer.clear()})),this._initalToolbar(),this._initialMeasureLayer()},_initialMeasureLayer:function(){this._measureLayer.on("mouse-over",a.hitch(this,function(e){var t=e.graphic;t.symbol.isClearBtn&&(this.map.setMapCursor("pointer"),s.once(t.getShape(),"click",a.hitch(this,function(){this._measureLayer.clear(),this.map.setMapCursor("default")})))})),this._measureLayer.on("mouse-out",a.hitch(this,function(e){this.map.setMapCursor("default")}))},_initalToolbar:function(){this.measure_toolBar=new i(this.map,{showTooltips:!0}),this.measure_toolBar.on("draw-complete",a.hitch(this,this._measureDrawComplete)),t("#t_distance").on("click",a.hitch(this,this._startMeasureDistance)),t("#t_area").on("click",a.hitch(this,this._startMeasureArea))},_measureDrawComplete:function(e){if("polygon"==e.geometry.type)this._endMeasureArea(e.geometry);else{var t=this._stopPoints[this._stopPoints.length-1];this._endMeasureDistance(e.geometry,t)}this.measure_toolBar.deactivate()},_startMeasureDistance:function(){this._clearMapMouseClickEvent(),this._stopPoints=[],this._stopDistances=[],this._measureLayer.clear(),this.measure_toolBar.deactivate(),this.measure_toolBar.activate(i.POLYLINE);var o=this._stopPoints,n=this._stopDistances,l=this;this._mapClickFlag=this.map.on("click",function(e){var t=0,a=e.mapPoint;if(0<o.length){var s=o[o.length-1];t=l._calDistance(s,a),0<l._stopDistances.length&&(t+=l._stopDistances[l._stopDistances.length-1]),n.push(t)}o.push(a);var r=new c(a,l.defaults.markerSymbol),i=l._getStopPointGraphic(a,t);l._measureLayer.add(r),l._measureLayer.add(i)})},_endMeasureDistance:function(e,t){var a=new c(e,this.measure_toolBar.lineSymbol),s=this._createClearBtn(t);this._measureLayer.add(s),this._measureLayer.add(a),a.getDojoShape().moveToBack(),this._clearMapMouseClickEvent()},_getStopPointGraphic:function(e,t){var a=this._createTextSymbol("起点");return 0<t&&1e3<=t?a=a.setText((t/1e3).toFixed(2)+"km"):0<t&&t<1e3&&(a=a.setText(t.toFixed()+"m")),new c(e,a)},_calDistance:function(e,t){var a=new l(this.map.spatialReference);return a.addPath([e,t]),this.map.spatialReference.isWebMercator()||"4326"==this.map.spatialReference.wkid?m.geodesicLength(a,"meters"):m.planarLength(a,"meters")},_startMeasureArea:function(){this._clearMapMouseClickEvent(),this._stopPoints=[],this._stopDistances=[],this._measureLayer.clear(),this.measure_toolBar.deactivate(),this.measure_toolBar.activate(i.POLYGON);var o=this._stopPoints,n=this._stopDistances,l=this;this._mapClickFlag=this.map.on("click",function(e){var t=0,a=e.mapPoint;if(0<o.length){var s=o[o.length-1];t=l._calDistance(s,a),0<l._stopDistances.length&&(t+=l._stopDistances[l._stopDistances.length-1]),n.push(t)}o.push(a);var r=new c(a,l.defaults.markerSymbol),i=l._getStopPointGraphic(a,t);l._measureLayer.add(r),l._measureLayer.add(i)})},_endMeasureArea:function(e){var t=this._calArea(e);t=1e6<t?(t/1e6).toFixed(2)+"平方千米":t.toFixed(2)+"平方米";var a=e.getCentroid(),s=new c(e,this.measure_toolBar.fillSymbol),r=this._createTextSymbol(t);r.setOffset(30,10);var i=new c(a,r),o=this._createClearBtn(a);this._measureLayer.add(s),this._measureLayer.add(i),this._measureLayer.add(o),s.getDojoShape().moveToBack(),this._clearMapMouseClickEvent()},_calArea:function(e){var t=this.map.spatialReference;return t.isWebMercator()||"4326"==t.wkid?m.geodesicArea(e,"square-meters"):m.planarArea(e,"square-meters")},_createClearBtn:function(e){var t=new h;return t.setOffset(-35,15),t.setPath("M13.618,2.397 C10.513,-0.708 5.482,-0.713 2.383,2.386 C-0.718,5.488 -0.715,10.517 2.392,13.622 C5.497,16.727 10.529,16.731 13.627,13.632 C16.727,10.533 16.724,5.502 13.618,2.397 L13.618,2.397 Z M9.615,11.351 L7.927,9.663 L6.239,11.351 C5.55,12.04 5.032,12.64 4.21,11.819 C3.39,10.998 3.987,10.48 4.679,9.79 L6.367,8.103 L4.679,6.415 C3.989,5.726 3.39,5.208 4.21,4.386 C5.032,3.566 5.55,4.165 6.239,4.855 L7.927,6.541 L9.615,4.855 C10.305,4.166 10.82,3.565 11.642,4.386 C12.464,5.208 11.865,5.726 11.175,6.415 L9.487,8.102 L11.175,9.789 C11.864,10.48 12.464,10.998 11.642,11.819 C10.822,12.64 10.305,12.04 9.615,11.351 L9.615,11.351 Z"),t.setColor(new o("#d50100")),t.setOutline(null),t.isClearBtn=!0,c(e,t)},_createTextSymbol:function(e){var t=new o("#000000"),a=new o("#fff"),s=new n("9pt",n.STYLE_ITALIC,n.VARIANT_NORMAL,n.WEIGHT_BOLD,"Courier"),r=new _(e,s,t);return r.setOffset(10,10).setHaloColor(a).setHaloSize(2),r.setAlign(_.ALIGN_MIDDLE),r},_clearMapMouseClickEvent:function(){null!=this._mapClickFlag&&this._mapClickFlag.remove()}})});