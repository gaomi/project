if(void 0===G_Dci_Info)var G_Dci_Info={};require(["dojo/dom","dojo/query","dojo/_base/lang","dojo/on","dojo/Deferred","esri/graphic","esri/layers/GraphicsLayer","esri/toolbars/draw","esri/geometry/geometryEngine","esri/geometry/scaleUtils","dojo/_base/array","dojo/topic","main/gisInterface/gis_Query.js"],function(e,t,r,i,a,l,o,s,u,n,c,y,d){G_Dci_Info.GeoQueryToolBar={map:null,query_toolBar:null,_queryLayer:null,_gisQuery:null,_layerListConfig:[],_queryDataLayerList:[],initGeoQuery:function(e){this.map=e,this._gisQuery=new d(this.map),this._getLayerListConfig(MapConfig.layerListCol,this._layerListConfig),this.map.getLayer("p_query_layer")?this.map.getLayer("p_query_layer").clear():(this._queryLayer=new o({id:"p_query_layer"}),this.map.addLayer(this._queryLayer)),y.subscribe("clearQueryLayer",r.hitch(this,function(){this._queryLayer.clear(),$("#divQueryContent").empty(),$("#divQueryResult").is(":visible")&&$("#divQueryResult").hide(200),$("#divQueryResultIcon").is(":visible")&&$("#divQueryResultIcon").hide(200)})),this.creatElement(),this._initalToolbar()},creatElement:function(){var e=new StringBuffer;e.append("<div id='divQueryResultIcon'><div class='resultIcon'></div></div>"),e.append("<div id='divQueryResult'>"),e.append("<div class='queryResultTitle'><img class='icon_result' src='./images/widget/geoQuery/queryResult.png' /><label>查询结果</label> <div id='hideQueryResult' class='closeLayer'></div></div>"),e.append("<div class='queryResultLine'></div>"),e.append("<div id='divQueryContent' class='divQueryContent'></div>"),e.append("<div>"),$("#map").append(e.toString()),t("#hideQueryResult").on("click",r.hitch(this,function(){$("#divQueryResult").hide(500),$("#divQueryResultIcon").show(600)})),t("#divQueryResultIcon").on("click",r.hitch(this,function(){$("#divQueryResult").show(500),$("#divQueryResultIcon").hide(400)}))},_initalToolbar:function(){this.query_toolBar=new s(this.map,{showTooltips:!0}),this.query_toolBar.on("draw-complete",r.hitch(this,this._drawQueryComplete)),t("#t_selectPoint").on("click",r.hitch(this,function(){this._getIsSelectMapLayer()?(this.map.setMapCursor("url('"+getRootPath()+"images/map/cursor/click02.cur'),auto"),this.query_toolBar.activate(s.POINT)):tipDialog("请选择需要查询的图层!",0,!1)})),t("#t_selectCircle").on("click",r.hitch(this,function(){this._getIsSelectMapLayer()?(this.map.setMapCursor("url('"+getRootPath()+"images/map/cursor/select.cur'),auto"),this.query_toolBar.activate(s.CIRCLE)):tipDialog("请选择需要查询的图层!",0,!1)})),t("#t_selectEllipse").on("click",r.hitch(this,function(){this._getIsSelectMapLayer()?(this.map.setMapCursor("url('"+getRootPath()+"images/map/cursor/select.cur'),auto"),this.query_toolBar.activate(s.ELLIPSE)):tipDialog("请选择需要查询的图层!",0,!1)})),t("#t_selectArea").on("click",r.hitch(this,function(){this._getIsSelectMapLayer()?(this.map.setMapCursor("url('"+getRootPath()+"images/map/cursor/select.cur'),auto"),this.query_toolBar.activate(s.EXTENT)):tipDialog("请选择需要查询的图层!",0,!1)})),t("#t_selectPolygon").on("click",r.hitch(this,function(){this._getIsSelectMapLayer()?(this.map.setMapCursor("url('"+getRootPath()+"images/map/cursor/select.cur'),auto"),this.query_toolBar.activate(s.POLYGON)):tipDialog("请选择需要查询的图层!",0,!1)}))},_drawQueryComplete:function(e){this.map.graphics.clear(),this.query_toolBar.deactivate();var t=null;t="point"==e.geometry.type?u.buffer(e.geometry,2.54*n.getScale(this.map)*.15/100,"meters"):e.geometry,this.map.setMapCursor("default"),this.map.setExtent(t.getExtent().expand(2));var r=this._getMapSelectLayer(this.map);if(r){showOperProDiv("数据查询中，请等待！");var i=new a;this._gisQuery.queryLayerByGeomerty(r,t,i),i.then(function(e){if($("#divQueryContent").empty(),$("#divQueryResultIcon").is(":visible")&&$("#divQueryResultIcon").hide(200),null!=e&&0<e.length){G_Dci_Info.GeoQueryToolBar._queryDataLayerList=[],G_Dci_Info.GeoQueryToolBar._filterQueryResultData(e,G_Dci_Info.GeoQueryToolBar._queryDataLayerList);var r='<div id="divQueryTable" class="divQueryTable">',i='<div id="divNavQuery" class="divNavQuery"><ul>';4<G_Dci_Info.GeoQueryToolBar._queryDataLayerList.length&&(i='<div id="divNavQuery" class="divNavQuery" style="height: 56px;"><ul>',r='<div id="divQueryTable" class="divQueryTable" style="height: calc(100% - 56px)">'),$.each(G_Dci_Info.GeoQueryToolBar._queryDataLayerList,function(e,t){0==e?(r+=G_Dci_Info.GeoQueryToolBar._generateTable(t.featureResultList)+"</div>",i+='<li id="'+t.serverId+"_"+t.id+'" class="active" onclick="G_Dci_Info.GeoQueryToolBar._generateTableByPar(\''+t.id+"','"+t.serverId+"')\">"+t.lable+"</li>"):i+='<li id="'+t.serverId+"_"+t.id+'" onclick="G_Dci_Info.GeoQueryToolBar._generateTableByPar(\''+t.id+"','"+t.serverId+"')\">"+t.lable+"</li>"}),i+='</ul></div><div class="divSplit"></div>',$("#divQueryContent").html(i+r),$("#divQueryResult").is(":hidden")&&$("#divQueryResult").show(500)}else $("#divQueryResult").is(":visible")&&$("#divQueryResult").hide(200),tipDialog("空间查询结果为空!",0,!1);hideOperProDiv()})}},_getIsSelectMapLayer:function(){var e=!1;if(0<this.map.layerIds.length)for(idx in this.map.layerIds){var t=this.map.getLayer(this.map.layerIds[idx]);if(t.isOperationalLayer&&t.visible&&0<t.layerInfos.length){e=!0;break}}return e},_getMapSelectLayer:function(t){var r="";try{return c.forEach(t.layerIds,function(e){var i=t.getLayer(e);if(i.isOperationalLayer&&i.visible&&0<i.layerInfos.length){var a="";c.forEach(i.visibleLayers,function(e){if(-1!==e){var t=i.layerInfos[e];if(null!=t&&null==t.subLayerIds){var r=i.url+"/"+e;a=a+'{"id":"'+t.id+'","name":"'+t.name+'","parentLayerId":"'+t.parentLayerId+'","serverId":"'+i.id+'","url":"'+r+'"},'}}}),0<a.length&&(a='{"serverid":"'+i.id+'","serverurl":"'+i.url+'","layerList":['+a.substr(0,a.length-1)+"]}",r=r+a+",")}}),0<r.length?JSON.parse("["+r.substr(0,r.length-1)+"]"):null}catch(e){return null}},_getLayerListConfig:function(e,r){"object"==typeof e&&$.each(e,function(e,t){if("Layer"==t.iconType)r.push(t);else if(t.childNodeCol&&0<t.childNodeCol.length)return G_Dci_Info.GeoQueryToolBar._getLayerListConfig(t.childNodeCol,r)})},_filterQueryResultData:function(e,r){$.each(e,function(e,t){t.layerResultList?G_Dci_Info.GeoQueryToolBar._filterQueryResultData(t.layerResultList,r):t.featureResultList&&0<t.featureResultList.length&&(t.lable=G_Dci_Info.GeoQueryToolBar._findLayerLayerByPar(t.url),r.push(t))})},_findLayerLayerByPar:function(r){var i="";return $.each(this._layerListConfig,function(e,t){if(t.url===r)return i=t.lable,!1}),i},_generateTable:function(e){var t='<table class="fancyTable" id="dataTable" border="1">',r="",i="";return $.each(e,function(e,t){0==e&&(r="<thead>"+G_Dci_Info.GeoQueryToolBar._generateTableTr(t.featureInfo,"th")+"</thead>",i+=G_Dci_Info.GeoQueryToolBar._generateTableTr(t.featureInfo,"td")),i+=G_Dci_Info.GeoQueryToolBar._generateTableTr(t.featureInfo,"td")}),t=t+r+i+"</table>"},_generateTableTr:function(e,t){if(!e)return"<tr>没有数据</tr>";var r=JSON.parse(e),i="<tr>";for(var a in r)"OBJECTID"!=a&&"Shape_Length"!=a&&"Shape_Area"!=a&&"Shape"!=a&&(i+="th"===t?"<th>"+a+"</th>":"<td>"+r[a]+"</td>");return i+="</tr>"},_generateTableByPar:function(r,i){$("#divNavQuery li").each(function(e){$(this)[0].id===i+"_"+r?$(this).addClass("active"):$(this).removeClass("active")}),$.each(G_Dci_Info.GeoQueryToolBar._queryDataLayerList,function(e,t){t.id===r&&t.serverId===i&&$("#divQueryTable").html(G_Dci_Info.GeoQueryToolBar._generateTable(t.featureResultList))})}}});