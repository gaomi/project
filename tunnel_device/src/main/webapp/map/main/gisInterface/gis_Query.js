define(["dojo/_base/declare","esri/map","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/geometryEngine","main/gisInterface/gis_SymbolUtil.js"],function(e,r,o,L,f,t){return e("Gis_Query",null,{_map:null,_gisSymbolUtil:null,constructor:function(e){_map=e,_gisSymbolUtil=new t(e)},queryLayerByGeomerty:function(e,r,c){try{var y=this._getJsonLayerCount(e),v=0,h=[],p=[],n=new o;n.spatialRelationship=o.SPATIAL_REL_INTERSECTS,n.outSpatialReference=_map.spatialReference,n.returnGeometry=!0,n.geometry=r,n.outFields=["*"],$.each(e,function(e,r){var t=new Object;t.serverId=r.serverid,t.serverUrl=r.serverurl,h.push(t);var f=[];$.each(r.layerList,function(e,l){var i=new Object;i.id=l.id,i.name=l.name,i.parentLayerId=l.parentLayerId,i.serverId=l.serverId,i.url=l.url,new L(l.url).execute(n,function(e){v+=1;for(var r=0;r<e.features.length;r++){var t=new Object,n="{",a=e.features[r].attributes;for(var s in a)n=n+'"'+s+'":"'+a[s]+'",';t.featureInfo=n.substr(0,n.length-1)+"}",t.featureGeo=e.features[r].geometry,_gisSymbolUtil.flashGeo(e.features[r].geometry),o.push(t)}0<o.length&&(i.featureResultList=o,f.push(i));for(var u in h)h[u].serverId==l.serverId&&(h[u].layerResultList=f);v==y&&(h.forEach(function(e,r){null!=e.layerResultList&&0<e.layerResultList.length&&p.push(e)}),c.resolve(p))},function(e){(v+=1)==y&&(h.forEach(function(e,r){null!=e.layerResultList&&0<e.layerResultList.length&&p.push(e)}),c.resolve(p))});var o=[]})})}catch(e){return null}},queryLayerByCondition:function(e,r,c){try{var y=this._getJsonLayerCount(e),v=0,h=[],p=[],n=new o;n.spatialRelationship=o.SPATIAL_REL_INTERSECTS,n.outSpatialReference=_map.spatialReference,n.returnGeometry=!0,n.where=r,n.outFields=["*"],$.each(e,function(e,r){var t=new Object;t.serverId=r.serverid,t.serverUrl=r.serverurl,h.push(t);var f=[];$.each(r.layerList,function(e,l){var i=new Object;i.id=l.id,i.name=l.name,i.parentLayerId=l.parentLayerId,i.serverId=l.serverId,i.url=l.url,new L(l.url).execute(n,function(e){v+=1;for(var r=0;r<e.features.length;r++){var t=new Object,n="{",a=e.features[r].attributes;for(var s in a)n=n+'"'+s+'":"'+a[s]+'",';t.featureInfo=n.substr(0,n.length-1)+"}",t.featureGeo=e.features[r].geometry,_gisSymbolUtil.flashGeo(e.features[r].geometry),o.push(t)}0<o.length&&(i.featureResultList=o,f.push(i));for(var u in h)h[u].serverId==l.serverId&&(h[u].layerResultList=f);v==y&&(h.forEach(function(e,r){null!=e.layerResultList&&0<e.layerResultList.length&&p.push(e)}),c.resolve(p))},function(e){(v+=1)==y&&(h.forEach(function(e,r){null!=e.layerResultList&&0<e.layerResultList.length&&p.push(e)}),c.resolve(p))});var o=[]})})}catch(e){return null}},queryDisLayerByCondition:function(e,r,t,n){try{var a=_map.getLayer(e);if(a){var s=a.url+"/"+r,u=new o;u.spatialRelationship=o.SPATIAL_REL_INTERSECTS,u.outSpatialReference=_map.spatialReference,u.returnGeometry=!0,u.where=t,u.outFields=["*"],new L(s).execute(u,function(e){for(var r=0;r<e.features.length;r++)l.push(e.features[r].geometry);i=f.union(l),n.resolve(i)},function(e){n.resolve(i)});var l=[],i=null}}catch(e){return null}},_getJsonLayerCount:function(e){var t=0;return $.each(e,function(e,r){t+=r.layerList.length}),t}})});